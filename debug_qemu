set -e

UTCS_OPT=-O0 make clean the_kernel $1 $1.data

echo "in a different window:"
echo "   'gdb kernel/build/kernel.kernel' or 'gdb $1.dir/sbin/init'"
echo "   target remote localhost:1234"
echo "   set breakpoint, etc"
echo "   continue"

time `make qemu_cmd` `make qemu_config_flags` \
             -s -S \
             -no-reboot \
             -nographic \
             --monitor none \
             -d guest_errors \
             -D qemu.log \
             -drive file=kernel/build/kernel.img,index=0,media=disk,format=raw \
             -drive file=$1.data,index=1,media=disk,format=raw \
             -device isa-debug-exit,iobase=0xf4,iosize=0x04 || true
